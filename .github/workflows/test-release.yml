name: Test Release (Safe)

on:
  workflow_dispatch:
    inputs:
      test_branch:
        description: 'Branch to test on (will be modified!)'
        required: true
        type: string
        default: 'test-release'

      release_target:
        description: 'What to release?'
        required: true
        type: choice
        options:
          - core-and-lib
          - component

      component_name:
        description: 'Component name (if releasing component)'
        required: false
        type: string

      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write

jobs:
  test-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout test branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.test_branch }}
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-release
        run: cargo install cargo-release

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate component name
        if: inputs.release_target == 'component' && inputs.component_name == ''
        run: |
          echo "Error: component_name is required when release_target is 'component'"
          exit 1

      # Test release core-and-lib
      - name: Test release core-and-lib
        if: inputs.release_target == 'core-and-lib'
        run: |
          echo "⚠️ TEST MODE: Publishing with --no-publish flag"
          echo "This will create commits and tags on branch: ${{ inputs.test_branch }}"
          echo "It will NOT publish to crates.io"

          cargo release ${{ inputs.version_bump }} \
            -p drasi-core \
            -p drasi-query-ast \
            -p drasi-query-cypher \
            -p drasi-query-gql \
            -p drasi-functions-cypher \
            -p drasi-functions-gql \
            -p drasi-middleware \
            -p drasi-lib \
            --no-publish \
            --execute

      # Test release component
      - name: Test release component
        if: inputs.release_target == 'component'
        run: |
          echo "⚠️ TEST MODE: Publishing with --no-publish flag"
          echo "This will create commits and tags on branch: ${{ inputs.test_branch }}"
          echo "It will NOT publish to crates.io"

          cargo release ${{ inputs.version_bump }} \
            -p ${{ inputs.component_name }} \
            --no-publish \
            --execute

      - name: Summary
        if: always()
        run: |
          echo "## Test Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ **THIS WAS A TEST - NOT PUBLISHED TO CRATES.IO**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Branch**: ${{ inputs.test_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ inputs.release_target }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.release_target }}" = "component" ]; then
            echo "- **Component**: ${{ inputs.component_name }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Version Bump**: ${{ inputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What Happened:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Updated Cargo.toml files with new versions" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Created git commit with version changes" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Created git tags" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Pushed commits and tags to branch: ${{ inputs.test_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- ❌ Did NOT publish to crates.io (--no-publish)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the commits on branch: ${{ inputs.test_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the Cargo.toml changes" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify the git tags were created correctly" >> $GITHUB_STEP_SUMMARY
          echo "4. If everything looks good, delete this test branch and use the real release workflow" >> $GITHUB_STEP_SUMMARY
