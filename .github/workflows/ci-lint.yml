name: Run cargo fmt and cargo clippy

on:
  push:
    branches:
      - main
      - release/*
  pull_request:
    branches:
      - main
      - feature/*
      - feature-lib
      - release/*

jobs:
  clippy_check:
    name: Cargo Clippy lint check
    # Clippy lints are now configured in Cargo.toml [workspace.lints] section
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Show Rust toolchain
        run: rustup show

      - name: Install dependencies for bundled jq + protobuf
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            protobuf-compiler \
            build-essential \
            autoconf \
            automake \
            libtool \
            make \
            gcc \
            g++ \
            pkg-config \
            flex \
            bison
      
      # # Prepare jq bundled sources (ensure generated lexer/parser C files exist)
      # - name: Prepare bundled jq source
      #   run: |
      #     cargo fetch
      #     JQ_SRC_DIR=$(ls -d ~/.cargo/registry/src/*/jq-src-* 2>/dev/null | head -n 1)
      #     if [ -n "$JQ_SRC_DIR" ] && [ -d "$JQ_SRC_DIR/modules/jq" ]; then
      #       cd "$JQ_SRC_DIR/modules/jq"
      #       if [ ! -f src/lexer.c ]; then
      #         flex -o src/lexer.c src/lexer.l
      #       fi
      #       if [ ! -f src/parser.c ]; then
      #         bison -d -o src/parser.c src/parser.y
      #       fi
      #     fi

      - name: Run Cargo Clippy
        run: cargo clippy --all-targets --all-features

  fmt_check:
    name: Format check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - name: Show Rust toolchain
        run: rustup show

      - name: Run Cargo fmt
        run: cargo fmt -- --check
