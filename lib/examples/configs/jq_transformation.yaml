# Simple JQ Transformation Example
#
# This example demonstrates a basic JQ middleware transformation that converts
# temperature from Celsius to Fahrenheit before the query processes the data.
#
# Use Case: Normalize temperature data from metric sensors to imperial units

server_core:
  id: temperature-converter

sources:
  - id: metric_sensors
    source_type: application
    properties:
      # Application source for testing
      # In production, this might be an HTTP or gRPC source
    auto_start: true

queries:
  - id: high-temperature-alert
    query: |
      MATCH (s:Sensor)
      WHERE s.temp_f > 80
      RETURN s.id as sensor_id, s.temp_f as temperature_fahrenheit, s.location

    # Define JQ middleware for temperature conversion
    middleware:
      - kind: jq
        name: celsius_to_fahrenheit
        config:
          Sensor:
            insert:
              - op: Insert
                label: "\"Sensor\""
                id: .id
                query: |
                  {
                    id: .id,
                    location: .location,
                    temp_c: .temp_c,
                    temp_f: ((.temp_c * 9 / 5) + 32),
                    timestamp: (now | todate)
                  }

    # Apply middleware to the source
    source_subscriptions:
      - source_id: metric_sensors
        pipeline: [celsius_to_fahrenheit]

    auto_start: true

reactions:
  - id: temperature-logger
    reaction_type: log
    queries: [high-temperature-alert]
    properties:
      log_level: info
    auto_start: true

# Test Data (send to application source):
# {
#   "id": "sensor-1",
#   "location": "Building A",
#   "temp_c": 30
# }
#
# Expected Output:
# {
#   "sensor_id": "sensor-1",
#   "temperature_fahrenheit": 86,
#   "location": "Building A"
# }
