/**
 * TypeSpec definition for Drasi gRPC Reaction Protocol
 *
 * This file defines the data structures used by the gRPC reaction to send
 * query results to external services. It corresponds to the Protocol Buffer
 * definitions in proto/drasi/v1/reaction.proto and proto/drasi/v1/common.proto.
 *
 * The gRPC reaction implements the client side of the drasi.v1.ReactionService
 * interface, sending ProcessResultsRequest messages to external services.
 */

import "@typespec/http";

using TypeSpec.Http;

@doc("Drasi gRPC Reaction Protocol - v1")
namespace Drasi.Reaction.V1;

/**
 * Request message sent to the gRPC service for processing query results.
 *
 * This is the top-level message sent via the ProcessResults RPC call.
 */
model ProcessResultsRequest {
  /**
   * The batch of query results to process
   */
  results: QueryResult;

  /**
   * Optional metadata to include with the request.
   *
   * Configured via the 'metadata' property in the reaction configuration.
   * Common uses include authentication tokens, tenant IDs, or routing hints.
   *
   * Example:
   * {
   *   "authorization": "Bearer eyJhbGc...",
   *   "x-tenant-id": "tenant-123",
   *   "x-request-source": "drasi-core"
   * }
   */
  metadata?: Record<string>;
}

/**
 * Response message returned by the gRPC service after processing results.
 *
 * The gRPC service must return this message to indicate success or failure.
 */
model ProcessResultsResponse {
  /**
   * Whether the processing was successful.
   *
   * If false, the reaction will retry based on max_retries configuration.
   */
  success: boolean;

  /**
   * Optional human-readable status message
   */
  message?: string;

  /**
   * Error description if success is false
   */
  error?: string;

  /**
   * Number of items successfully processed from the batch
   */
  items_processed?: uint32;
}

/**
 * A batch of query results for a specific query.
 *
 * Contains all the result items generated by a single query,
 * along with metadata about when the results were produced.
 */
model QueryResult {
  /**
   * Unique identifier of the query that produced these results.
   *
   * Corresponds to the query ID in the Drasi configuration.
   */
  query_id: string;

  /**
   * Array of individual result items.
   *
   * Each item represents a single change (ADD, UPDATE, or DELETE) in the query results.
   * Batched together for efficient transmission.
   */
  results: QueryResultItem[];

  /**
   * Timestamp when these results were generated.
   *
   * Uses RFC 3339 format (e.g., "2024-01-31T12:00:00Z")
   * Corresponds to google.protobuf.Timestamp in the protobuf definition.
   */
  @encodedName("application/json", "timestamp")
  timestamp: utcDateTime;
}

/**
 * A single query result item representing a change in the query output.
 *
 * Each item represents one of three operations:
 * - ADD: A new row appeared in the query results
 * - UPDATE: An existing row was modified
 * - DELETE: A row was removed from the query results
 */
model QueryResultItem {
  /**
   * Type of operation that occurred.
   *
   * Valid values:
   * - "ADD": New row added to query results
   * - "UPDATE": Existing row modified
   * - "DELETE": Row removed from query results
   */
  type: "ADD" | "UPDATE" | "DELETE";

  /**
   * The main data payload.
   *
   * For ADD and DELETE operations:
   * - Contains the complete row data
   *
   * For UPDATE operations:
   * - May contain additional change metadata
   * - Use 'before' and 'after' for the actual changes
   *
   * This is a flexible JSON structure (google.protobuf.Struct in protobuf)
   * that can contain any query result data.
   *
   * Example for ADD:
   * {
   *   "id": "sensor-1",
   *   "temperature": 28.5,
   *   "location": "room-101",
   *   "timestamp": "2024-01-31T12:00:00Z"
   * }
   */
  data: Record<unknown>;

  /**
   * Previous state of the row (UPDATE operations only).
   *
   * Contains the row data before the update occurred.
   * This field is only present for UPDATE operations.
   *
   * Example:
   * {
   *   "id": "sensor-1",
   *   "temperature": 28.5,
   *   "location": "room-101"
   * }
   */
  before?: Record<unknown>;

  /**
   * New state of the row (UPDATE operations only).
   *
   * Contains the row data after the update occurred.
   * This field is only present for UPDATE operations.
   *
   * Example:
   * {
   *   "id": "sensor-1",
   *   "temperature": 32.1,
   *   "location": "room-101"
   * }
   */
  after?: Record<unknown>;
}

/**
 * Example: Complete ProcessResultsRequest for ADD operation
 *
 * {
 *   "results": {
 *     "query_id": "temperature-alerts",
 *     "results": [
 *       {
 *         "type": "ADD",
 *         "data": {
 *           "sensor_id": "sensor-1",
 *           "temperature": 35.2,
 *           "location": "datacenter-1",
 *           "alert_level": "high"
 *         }
 *       }
 *     ],
 *     "timestamp": "2024-01-31T14:30:00Z"
 *   },
 *   "metadata": {
 *     "authorization": "Bearer eyJhbGc...",
 *     "x-tenant-id": "prod-tenant"
 *   }
 * }
 */

/**
 * Example: ProcessResultsRequest with UPDATE operation
 *
 * {
 *   "results": {
 *     "query_id": "sensor-monitoring",
 *     "results": [
 *       {
 *         "type": "UPDATE",
 *         "before": {
 *           "sensor_id": "sensor-1",
 *           "temperature": 28.5,
 *           "status": "normal"
 *         },
 *         "after": {
 *           "sensor_id": "sensor-1",
 *           "temperature": 35.2,
 *           "status": "warning"
 *         }
 *       }
 *     ],
 *     "timestamp": "2024-01-31T14:30:15Z"
 *   },
 *   "metadata": {
 *     "x-request-id": "req-12345"
 *   }
 * }
 */

/**
 * Example: ProcessResultsRequest with DELETE operation
 *
 * {
 *   "results": {
 *     "query_id": "active-sensors",
 *     "results": [
 *       {
 *         "type": "DELETE",
 *         "data": {
 *           "sensor_id": "sensor-1",
 *           "temperature": 35.2,
 *           "location": "datacenter-1"
 *         }
 *       }
 *     ],
 *     "timestamp": "2024-01-31T14:31:00Z"
 *   }
 * }
 */

/**
 * Example: Batched ProcessResultsRequest with multiple operations
 *
 * {
 *   "results": {
 *     "query_id": "sensor-changes",
 *     "results": [
 *       {
 *         "type": "ADD",
 *         "data": {
 *           "sensor_id": "sensor-2",
 *           "temperature": 22.1
 *         }
 *       },
 *       {
 *         "type": "UPDATE",
 *         "before": {
 *           "sensor_id": "sensor-3",
 *           "temperature": 25.0
 *         },
 *         "after": {
 *           "sensor_id": "sensor-3",
 *           "temperature": 27.5
 *         }
 *       },
 *       {
 *         "type": "DELETE",
 *         "data": {
 *           "sensor_id": "sensor-4",
 *           "temperature": 30.0
 *         }
 *       }
 *     ],
 *     "timestamp": "2024-01-31T14:32:00Z"
 *   },
 *   "metadata": {
 *     "x-batch-size": "3",
 *     "x-source": "drasi-core"
 *   }
 * }
 */

/**
 * gRPC Service Definition (for reference)
 *
 * The gRPC reaction calls the ProcessResults RPC method:
 *
 * service ReactionService {
 *   rpc ProcessResults(ProcessResultsRequest) returns (ProcessResultsResponse);
 * }
 *
 * Endpoint configuration:
 * - Uses HTTP/2 protocol
 * - Default endpoint: grpc://localhost:50052
 * - Supports metadata headers for authentication and routing
 *
 * The reaction batches multiple QueryResultItems together and sends them
 * in a single ProcessResultsRequest based on batch_size and
 * batch_flush_timeout_ms configuration.
 */

/**
 * Protocol Buffer Type Mappings
 *
 * TypeSpec Type           → Protobuf Type
 * --------------------------------------------------------
 * string                  → string
 * boolean                 → bool
 * uint32                  → uint32
 * utcDateTime             → google.protobuf.Timestamp
 * Record<unknown>         → google.protobuf.Struct
 * Record<string>          → map<string, string>
 * []                      → repeated
 * ?                       → optional field
 *
 * Conversion Notes:
 * - Record<unknown> maps to google.protobuf.Struct, allowing arbitrary JSON
 * - All JSON values are converted to protobuf Value types
 * - Numbers become number_value (float64)
 * - Strings become string_value
 * - Booleans become bool_value
 * - Null becomes null_value
 * - Arrays become list_value
 * - Objects become struct_value
 */

/**
 * Batching Behavior
 *
 * The gRPC reaction batches results before sending:
 *
 * 1. Results accumulate until batch_size is reached
 * 2. If batch_flush_timeout_ms elapses, partial batch is sent
 * 3. If query_id changes, current batch is flushed
 * 4. On shutdown, final batch is flushed
 *
 * Configuration example:
 * {
 *   "batch_size": 100,              // Max items per batch
 *   "batch_flush_timeout_ms": 1000  // Max wait time (1 second)
 * }
 *
 * A single ProcessResultsRequest can contain multiple QueryResultItems,
 * all from the same query_id, representing a batch of changes.
 */

/**
 * Error Handling
 *
 * If ProcessResultsResponse.success is false:
 * - The reaction retries up to max_retries times
 * - Exponential backoff between retries (100ms base, 2x multiplier)
 * - Connection errors trigger reconnection attempts
 * - After max retries, batch is dropped and error is logged
 *
 * Response handling:
 * - success: true → Batch processed successfully
 * - success: false → Retry with exponential backoff
 * - gRPC errors → Connection error handling
 */
