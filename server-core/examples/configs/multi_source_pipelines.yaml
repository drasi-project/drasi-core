# Multiple Sources with Different Pipelines Example
#
# This example shows how different sources can have different transformation pipelines.
# Each source is processed differently based on its data quality and format.
#
# Use Case: Unify data from multiple sources with varying quality levels

server_core:
  id: multi-source-processor

sources:
  # Raw external data - needs full processing
  - id: external_api
    source_type: application
    auto_start: true

  # Partner data - needs validation and normalization
  - id: partner_feed
    source_type: application
    auto_start: true

  # Internal data - pre-validated, only needs normalization
  - id: internal_system
    source_type: application
    auto_start: true

  # Pre-processed data - ready to use
  - id: processed_warehouse
    source_type: application
    auto_start: true

queries:
  - id: unified-data-view
    query: |
      MATCH (d:DataPoint)
      WHERE d.value > 0 AND d.value < 10000
      RETURN d.id, d.value, d.source, d.timestamp, d.quality_score

    middleware:
      # Validation: Ensure data quality
      - kind: jq
        name: validate_data
        config:
          DataPoint:
            insert:
              - op: Insert
                label: "\"DataPoint\""
                id: .id
                query: |
                  select(.value != null and .value > 0 and .value < 10000)

      # Normalization: Standardize format
      - kind: jq
        name: normalize_format
        config:
          DataPoint:
            insert:
              - op: Insert
                label: "\"DataPoint\""
                id: .id
                query: |
                  {
                    id: .id,
                    value: (.value | tonumber),
                    source: .source,
                    timestamp: (.timestamp // (now | todate)),
                    quality_score: (.quality_score // 5)
                  }

      # Enrichment: Add metadata for external sources
      - kind: jq
        name: enrich_external
        config:
          DataPoint:
            insert:
              - op: Insert
                label: "\"DataPoint\""
                id: .id
                query: |
                  . + {
                    is_external: true,
                    requires_audit: true,
                    verified_at: (now | todate)
                  }

      # Quality scoring for partner data
      - kind: jq
        name: score_partner_quality
        config:
          DataPoint:
            insert:
              - op: Insert
                label: "\"DataPoint\""
                id: .id
                query: |
                  . + {
                    quality_score: (
                      if .verified == true then 8
                      elif .confidence > 0.7 then 6
                      else 4
                      end
                    )
                  }

    # Different pipeline for each source based on data quality
    source_subscriptions:
      # External API: Full pipeline (validate → normalize → enrich)
      - source_id: external_api
        pipeline:
          - validate_data
          - normalize_format
          - enrich_external

      # Partner feed: Validation, normalization, and quality scoring
      - source_id: partner_feed
        pipeline:
          - validate_data
          - normalize_format
          - score_partner_quality

      # Internal system: Only normalization (already validated)
      - source_id: internal_system
        pipeline:
          - normalize_format

      # Processed warehouse: No pipeline (ready to use)
      - source_id: processed_warehouse
        pipeline: []

    auto_start: true

reactions:
  - id: unified-logger
    reaction_type: log
    queries: [unified-data-view]
    properties:
      log_level: info
    auto_start: true

# Test Data Examples:

# External API (needs full processing):
# {
#   "id": "ext-1",
#   "value": "100",
#   "source": "external_api"
# }

# Partner Feed (needs validation and scoring):
# {
#   "id": "partner-1",
#   "value": 250,
#   "source": "partner_feed",
#   "verified": true,
#   "confidence": 0.9
# }

# Internal System (needs normalization):
# {
#   "id": "int-1",
#   "value": 500,
#   "source": "internal_system",
#   "quality_score": 9
# }

# Processed Warehouse (ready to use):
# {
#   "id": "wh-1",
#   "value": 750,
#   "source": "processed_warehouse",
#   "timestamp": "2024-01-01T10:00:00Z",
#   "quality_score": 10
# }
